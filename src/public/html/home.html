<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8" />
	<title>SoundClone Home</title>
	<link rel="stylesheet" href="../css/index.css" />
	<link rel="stylesheet" href="../css/home.css" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
</head>

<body>
	<header class="navbar">
		<div class="logo">ğŸµ SoundClone</div>
		<nav>
			<ul class="menu">
				<li><a href="home.html">Home</a></li>
				<li><a href="library.html">Library</a></li>
			</ul>
		</nav>
		<div class="search-container">
			<input type="text" placeholder="Search for artists, bands, tracks, podcasts" />
			<button class="search-btn">ğŸ”</button>
		</div>
		<div class="user-buttons" id="authArea">
			<button class="upload-btn" onclick="location.href='upload.html'">Upload</button>
			<button class="more-btn">â€¢â€¢â€¢</button>
			<button class="sign-in-btn" onclick="location.href='login.html?returnTo=home.html'">Sign in</button>
			<button class="create-account-btn" onclick="location.href='signup.html'">Create account</button>
		</div>
	</header>

	<main class="main-content">
		
		<section class="home-section">
			<h2 class="section-title">New Uploads</h2>
			<div class="card-row" id="new-uploads-container">
				<div style="padding: 20px; color: #888;">Loading...</div>
			</div>
		</section>

		<section class="home-section">
			<h2 class="section-title">Recently Played</h2>
			<div class="card-row" id="recent-container">
				</div>
		</section>

		<section class="home-section">
			<h2 class="section-title">Liked by You</h2>
			<div class="card-row" id="liked-container">
				</div>
		</section>

		<section class="home-section">
			<h2 class="section-title">Your Playlists</h2>
			<div class="card-row" id="playlist-container">
				</div>
		</section>

		<section class="home-section">
			<h2 class="section-title">Popular Artists</h2>
			<div class="card-row">
				<a class="card" href="javascript:void(0)">
					<div class="card-cover">
						<img src="../assets/artist.jpg" alt="Artist" onerror="this.src='../assets/default_profile.jpg'" />
					</div>
					<div class="card-title">Kairikibear</div>
					<div class="card-artist">Popular artist</div>
				</a>
			</div>
		</section>
	</main>

	<footer class="player-bar">
		<div class="player-bar-section">
			<button id="footer-play-pause-btn" class="bar-btn" aria-label="Play/Pause">
				<span class="icon play">â–¶</span>
				<span class="icon pause">â¸</span>
			</button>
			<span id="footer-current-time">0:00</span>
			<input type="range" id="progress-bar" min="0" max="100" value="0" />
			<span id="footer-duration-time">0:00</span>
			<input type="range" id="volume-slider" min="0" max="100" value="25" />
			<span class="volume-icon">ğŸ”Š</span>
		</div>
	</footer>

	<script src="../js/router.js"></script>

	<script>
		// ---------------------------------------------------------
		// A. ì¸ì¦(ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ) ì²˜ë¦¬
		// ---------------------------------------------------------
		function renderAuth() {
			const p = JSON.parse(localStorage.getItem('profile'));
			const area = document.getElementById('authArea');

			const uploadBtnHtml = `<button class="upload-btn" onclick="location.href='upload.html'">Upload</button>`;
			const moreBtnHtml = `<button class="more-btn">â€¢â€¢â€¢</button>`;

			if (p && area) {
				area.innerHTML = `
					${uploadBtnHtml}
					${moreBtnHtml}
					<div style="display:flex;align-items:center;gap:8px;cursor:pointer;">
						<img src="${p.img}" style="width:38px;height:38px;border-radius:50%;object-fit:cover;background:#eee;border:1px solid #bbb;" alt="í”„ë¡œí•„" />
						<span style="font-size:16px;color:#fff;font-weight:bold;">${p.name}</span>
						<button onclick="logout()" style="margin-left:8px;padding:5px 16px;border-radius:5px;background:#444;color:#fff;border:none;cursor:pointer;">Logout</button>
					</div>`;
			} else if (area) {
				area.innerHTML = `
					${uploadBtnHtml}
					${moreBtnHtml}
					<button class="sign-in-btn" onclick="location.href='login.html?returnTo=home.html'">Sign in</button>
					<button class="create-account-btn" onclick="location.href='signup.html'">Create account</button>`;
			}
		}

		function logout() {
			localStorage.removeItem('profile');
			renderAuth();
		}
		
		// í˜ì´ì§€ ë¡œë“œ ì‹œ ì¸ì¦ ì²´í¬
		renderAuth();


		// ---------------------------------------------------------
		// B. í™ˆ í™”ë©´ íŠ¸ë™ ë Œë”ë§ ë©”ì¸ í•¨ìˆ˜ (globalPlayer.jsì—ì„œ í˜¸ì¶œ)
		// ---------------------------------------------------------
		window.renderHomeTracks = function(tracks) {
			// 1. New Uploads: ì „ì²´ ëª©ë¡, ì‚­ì œ ë²„íŠ¼ í¬í•¨
			renderSection('new-uploads-container', tracks, true);

			// 2. Recently Played: ì•ì—ì„œ 3ê°œë§Œ í‘œì‹œ (ì‹œë®¬ë ˆì´ì…˜)
			renderSection('recent-container', tracks.slice(0, 3), false);

			// 3. Liked by You: ë’¤ì—ì„œ 3ê°œë§Œ í‘œì‹œ (ì‹œë®¬ë ˆì´ì…˜)
			renderSection('liked-container', [...tracks].reverse().slice(0, 3), false);

			// 4. Playlist: íŠ¸ë™ ê°œìˆ˜ë¥¼ ë³´ì—¬ì£¼ëŠ” ë”ë¯¸ ì¹´ë“œ ìƒì„±
			const playlistContainer = document.getElementById('playlist-container');
			if(playlistContainer) {
				playlistContainer.innerHTML = `
				<a class="card" href="javascript:void(0)">
					<div class="card-cover" style="background:#444;display:flex;align-items:center;justify-content:center;font-size:40px;">ğŸ§</div>
					<div class="card-title">My Awesome Mix</div>
					<div class="card-artist">${tracks.length} tracks</div>
				</a>`;
			}
		}

		// ---------------------------------------------------------
		// C. ì„¹ì…˜ë³„ ë Œë”ë§ í—¬í¼ í•¨ìˆ˜
		// ---------------------------------------------------------
		function renderSection(containerId, trackList, showDeleteBtn) {
			const container = document.getElementById(containerId);
			if (!container) return;

			container.innerHTML = ''; 

			if (!trackList || trackList.length === 0) {
				container.innerHTML = '<div style="padding:10px; color:#aaa;">í‘œì‹œí•  ê³¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
				return;
			}

			trackList.forEach((track) => {
				// ì „ì—­ íŠ¸ë™ ë¦¬ìŠ¤íŠ¸ì—ì„œì˜ ì‹¤ì œ ì¸ë±ìŠ¤ë¥¼ ì°¾ìŒ (ì¬ìƒ ì—°ë™ì„ ìœ„í•´ í•„ìˆ˜)
				const originalIndex = window.GlobalTracks.findIndex(t => t.id === track.id);

				const wrapper = document.createElement('div');
				wrapper.style.position = 'relative';
				wrapper.style.display = 'inline-block';

				// ì‚­ì œ ë²„íŠ¼ ìƒì„± (ì˜µì…˜)
				if (showDeleteBtn) {
					const delBtn = document.createElement('button');
					delBtn.innerHTML = 'âœ•';
					delBtn.style.position = 'absolute';
					delBtn.style.top = '5px';
					delBtn.style.right = '5px';
					delBtn.style.background = 'rgba(0,0,0,0.7)';
					delBtn.style.color = 'white';
					delBtn.style.border = 'none';
					delBtn.style.borderRadius = '50%';
					delBtn.style.width = '24px';
					delBtn.style.height = '24px';
					delBtn.style.cursor = 'pointer';
					delBtn.style.zIndex = '10';
					delBtn.title = "ì‚­ì œí•˜ê¸°";
					
					delBtn.onclick = (e) => {
						e.stopPropagation();
						deleteTrack(track.id);
					};
					wrapper.appendChild(delBtn);
				}

				// ì¹´ë“œ ìƒì„±
				const card = document.createElement('a');
				card.className = 'card';
				// router.jsê°€ ê°ì§€í•  ìˆ˜ ìˆë„ë¡ href ì„¤ì •
				card.href = 'index.html'; 
				
				card.onclick = (e) => {
					e.preventDefault(); // ê¸°ë³¸ ì´ë™ ë§‰ìŒ
					
					if (window.globalPlayer) {
						// ê°™ì€ ê³¡ì´ë©´ ì¬ìƒ ìƒíƒœ ìœ ì§€í•œ ì±„ ì´ë™ (ì´ì–´ë“£ê¸°)
						// ë‹¤ë¥¸ ê³¡ì´ë©´ ë³€ê²½ í›„ ì¬ìƒ (ì²˜ìŒë¶€í„°)
						if (window.globalPlayer.currentTrackIndex !== originalIndex) {
							window.globalPlayer.setTrack(originalIndex);
						}
						// SPA ë¼ìš°í„°ë¡œ í˜ì´ì§€ ì´ë™ ìš”ì²­
						navigate('index.html');
					}
				};

				card.innerHTML = `
					<div class="card-cover">
						<img src="${track.albumCover}" alt="${track.title}" onerror="this.src='../assets/albumart.jpg'" />
					</div>
					<div class="card-title">${track.title}</div>
					<div class="card-artist">${track.artist}</div>
				`;
				
				wrapper.appendChild(card);
				container.appendChild(wrapper);
			});
		}

		// ---------------------------------------------------------
		// D. íŠ¸ë™ ì‚­ì œ í•¨ìˆ˜ (API)
		// ---------------------------------------------------------
		async function deleteTrack(id) {
			if(!confirm('ì •ë§ë¡œ ì´ ê³¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (íŒŒì¼ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤)')) return;

			try {
				const res = await fetch(`http://localhost:3000/api/tracks/${id}`, {
					method: 'DELETE'
				});
				if(res.ok) {
					alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
					// ë¦¬ìŠ¤íŠ¸ ê°±ì‹ ì„ ìœ„í•´ ìƒˆë¡œê³ ì¹¨ (ë¼ìš°í„° í™˜ê²½ì—ì„œëŠ” fetchTracks ì¬í˜¸ì¶œì´ ë” ì¢‹ì§€ë§Œ ê°„ë‹¨íˆ ì²˜ë¦¬)
					location.reload(); 
				} else {
					alert('ì‚­ì œ ì‹¤íŒ¨: ì„œë²„ ì˜¤ë¥˜');
				}
			} catch(e) {
				console.error(e);
				alert('ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
			}
		}
	</script>

	<script src="../js/globalPlayer.js"></script>
	<script src="../js/player.js"></script>
</body>

</html>